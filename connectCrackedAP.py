#!/usr/bin/env python2

import csv
import os
import sys
from subprocess import Popen, call, PIPE
import time


def wpaConnect(bssid, encryption, essid, password, wpsNumber):
    # We have a WPA or WPA 2 Network so we start writing out the configuration file for wpa_supplicant
    print "Writing config file for WPA/WPA2 network"
    handler = open("wpa.conf", "w")
    handler.write("# WPA/WPA2 PSK Config file\r\n")
    handler.write("\r\n")
    handler.write("network={\r\n")
    handler.write("\r\n")
    handler.write(' ssid="' + essid + '"\r\n')
    handler.write(" scan_ssid=1\r\n")
    handler.write(" key_mgmt=WPA-PSK\r\n")
    handler.write(' psk="' + password + '"\r\n')
    handler.write("\r\n")
    handler.write("}")
    handler.close()
                
    # Point wpa_supplicant to the file and specify our interface and driver to use.
    # Note that os.system is used here as otherwise we would not be able to get
    # the error output from wpa_supplicant into out.log
    print "Executing WPA Supplicant...\r\n"
    os.system("wpa_supplicant -D wext -c wpa.conf -i wlan0 | tee out.log")
            
    fileHandler = open("out.log", "r")
    fileHandler.readline()
    line = fileHandler.readline()
       
                       
    if (line[:20] == "Failed to initialize" or line[:14] == "Failed to read"):
        print "\r\nSorry we were unable to connect to the network....\r\n"
               
               
    else:
        print "\r\nWe successfully connected to the network.\r\n"
        
#end wpaConnect function


essidToConnect = ""

try:
    essidToConnect = sys.argv[1]
    print "The essid to connect to is " + essidToConnect + "\r\n"

except:
    print "No essid specified as a parameter....defaulting to last one in the list."

with open('cracked.csv', 'rb') as csvfile:
    targetReader = csv.reader(csvfile, delimiter=',', quotechar='"')
    
    for line in targetReader:
        bssid = line[0]
        encryption = line[1]
        
        if (encryption == "WPA"):           
            essid = line[2]
            
            if (essidToConnect != ""):
                if (essidToConnect == essid):
                
                    print "Found it!"
                    print "Connecting to " + essid + "\r\n"
            
                    password = line[3]
                    wpsNumber = ""
        
                    if (line[4] != "False"):
                        wpsNumber = line[4]
          
                    # End the cycle once we have found the one we are looking for.
                    wpaConnect(bssid, encryption, essid, password, wpsNumber)
                    break
                 
                else:
                    print "Not it..."
            
            else:
                # grab the last line
                array = []
                handler = open ("cracked.csv", "r")   
                for line in handler.readlines():
                    array.append(line)
                
                handler.close()
                
                # Split each element using the , as the delimiter
                array = array[-1].split(",")
                
                # Remove the \r\n from the last element
                array[4] = array[4].strip()
               
                bssid = array[0]
                encryption = array[1]
                essid = array[2]
                password = array[3]
                if (array[4] != "False"):
                        wpsNumber = array[4]
                else:
                    wpsNumber = ""
                
                print "Connecting to " + essid + "\r\n"
                wpaConnect(bssid, encryption, essid, password, wpsNumber)
                break
                           
         
    
     # WEP PART!!!       
        else:
            # We now now that the network is a WEP network
            encryption = line[1]
            essid = line[2]
            key = line[3]   
                
            # We now set the ESSID of the network
            print "Setting ESSID for WEP network"
            executeHandler = Popen(["iwconfig", 
                                    "wlan0", 
                                    "essid",
                                    essid], stdout=0)
            
            # We now set the key for the network
            print "Setting the key for the WEP network"
            executeHandler = Popen(["iwconfig", 
                                    "wlan0", 
                                    "key",
                                    key], stdout=0)
                
            # We now set encryption to on
            print "Turning encryption on"
            executeHandler = Popen(["iwconfig", 
                                    "wlan0", 
                                    "enc",
                                    "on"], stdout=0)
                
            # We now attempt to get an IP
            print "Getting an IP address"
            executeHandler = Popen(["dhclient", 
                                    "wlan0"], stdout=0)
            
            
            # And whle we are at it lets make sure that the process doesn't run away by
            # waiting and then exiting the program if it hasn't already finished.
            startTime = time.time()        
            while ((time.time() - startTime) < waitTime):
                #just wait
                timeTaken = (time.time() - startTime)
                round(timeTaken)
            
            print "Killing IP address grabber...\r\n"
            executeHandler.kill()
